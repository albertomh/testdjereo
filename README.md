# testdjereo

[![python 3.12](https://img.shields.io/badge/3.12-4584b6?logo=python&logoColor=ffde57)](https://docs.python.org/3.12/whatsnew/.html)
[![justfile](https://img.shields.io/badge/ðŸ¤–_justfile-EFF1F3)](https://github.com/casey/just)
[![uv](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/astral-sh/uv/main/assets/badge/v0.json&labelColor=261230&color=de60e9)](https://github.com/astral-sh/uv)
[![Django](https://img.shields.io/badge/Django-092E20?logo=django&logoColor=ffffff)](https://docs.djangoproject.com/en/stable/)
[![Postgres](https://img.shields.io/badge/Postgres-346791?logo=postgresql&logoColor=ffffff)](https://www.postgresql.org/docs/)
[![IPython](https://img.shields.io/badge/IP[y]:-3465a4)](https://ipython.readthedocs.io/en/stable/)
[![structlog](https://img.shields.io/badge/ðŸªµ_structlog-b9a198)](https://github.com/hynek/structlog)
[![pre-commit](https://img.shields.io/badge/pre--commit-FAB040?logo=pre-commit&logoColor=1f2d23)](https://github.com/pre-commit/pre-commit)
[![ruff](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/astral-sh/ruff/main/assets/badge/v2.json&labelColor=261230&color=d8ff64)](https://github.com/astral-sh/ruff)
[![htmx](https://img.shields.io/badge/htmx-FFFFFF?logo=htmx&logoColor=3D72D7)](https://github.com/bigskysoftware/htmx)[![biome](https://img.shields.io/badge/Biome-FFFFFF?logo=biome&logoColor=60A5FA)](https://github.com/biomejs/biome)
[![nox](https://img.shields.io/badge/%F0%9F%A6%8A-Nox-D85E00.svg)](https://github.com/wntrblm/nox)
[![coverage](https://img.shields.io/badge/ðŸ˜´_coverage-59aabd)](https://coverage.readthedocs.io/)
[![security: bandit](https://img.shields.io/badge/security-bandit-yellow.svg)](https://github.com/PyCQA/bandit)
[![Release Please](https://img.shields.io/badge/ðŸ“¦_Release_Please-6C97BB)](https://github.com/googleapis/release-please)[![gunicorn](https://img.shields.io/badge/gunicorn-f7f8f2?logo=gunicorn&logoColor=499848)](https://docs.gunicorn.org/en/latest/index.html)

## Prerequisites

To use `testdjereo` the following must be available locally:

- [Python 3.12](https://docs.python.org/3.12/) or above
- [Postgres](https://www.postgresql.org/download/)
- [uv](https://docs.astral.sh/uv/)
- [just](https://github.com/casey/just)
- [nox](https://nox.thea.codes/en/stable/)

## Quickstart: run locally

A `justfile` defines common development tasks. Run `just` to show all available recipes.

```sh
# 1/5 create a postgres user and database for your project - change 'password' below
psql -U $(whoami) -d postgres -v APP_USER_PASSWORD='password' -f _db/set_up.sql

# 2/5 update the {password} in the DATABASE_URL connection strings in both .env & .env.test
# The .env file is created for you as a post-creation task.

# 3/5 apply migrations to the database
just manage migrate

# 4/5 create three users: admin, staff and regular (non-privileged)
just manage seed_database

# 5/5 install dependencies in a virtual environment and run the Django development server
just runserver
```

IPython is available as the default shell. Start an interactive session with:

```sh
just shell
```

## Develop

### Development prerequisites

In addition to the [Prerequisites](#prerequisites) above, you will need the following to
develop `testdjereo`:

- [pre-commit](https://pre-commit.com/)

### Style

Code style is enforced by pre-commit hooks.

```sh
# before you start developing, install pre-commit hooks
pre-commit install
```

See [Git principles](docs/README-dev.md#git-principles) & [Style](docs/README-dev.md#style)
in the developer README for more.

### Dependency management

Dependencies are defined in the `pyproject.toml` file, with exact versions captured by a
`uv.lock` lockfile. `uv` is used to manage dependencies:

```sh
# add a dependency to the project
uv add some-package
```

Dependabot is configured to run weekly and update Python packages (minor & patch) and
GitHub Actions. See [.github/dependabot.yaml](.github/dependabot.yaml).

### Logging

`testdjereo` uses [structlog](https://www.structlog.org/en/stable/) when DEBUG is
False. This configuration is intended for deployed environments such as production. When
DEBUG is True, as it usually is when developing locally, `rich` is used to format logs.
The logging configuration is generated by `logging.LoggingConfigFactory`.

You may issue logs as follows:

```python
import structlog

logger = structlog.get_logger()
logger.info("testdjereo is running", key="value")
```

### Models

The core app (`testdjereo`) defines an `UuidModel` abstract model. Models that
subclass it will have primary keys that are UUIDs instead of the default `BigAutoField`.
Models in the 'users' app extend `UuidModel` and it can be used by any new models.

Utility abstract models `CreatedAtModel`, `UpdatedAtModel` and `DeletedAtModel` (for
soft-deletion) are available to store timestamps.

## `htmx` frontend

A vendorised copy of `htmx` is included in the `_base.html` template via `django-htmx`'s
`{% htmx_script %}` tag.
The `django-htmx` package is used to smoothly integrate `htmx` into projects, abstracting
away header checks and allowing views to change their behaviour and responses based on the
`request.htmx` attribute.

See the [django-htmx documentation](https://django-htmx.readthedocs.io/en/latest/index.html)
for more.

## Test

Django's test runner (using the standard library's `unittest`) is used for the suite of
unit tests. Nox is used to automate testing across different Python versions.

```sh
# run all tests and report on code coverage
nox [-- <expression>]

# eg. to only run tests inside the `test_migrations` module
nox -- testdjereo.tests.test_migrations

# eg. to use `pdb` to debug tests
nox -- --pdb
```

By default `nox` will only run the session for the latest supported Python release.

Read more about tests, how they are configured, and how to profile them in
[README-dev.md#running-tests-with-nox](./docs/README-dev.md#running-tests-with-nox).

### End-to-end (e2e) tests

A suite of end-to-end tests written using the Playwright framework lives under `tests_e2e/`.
Invoke the `e2e` just recipe to run these locally:

```sh
just e2e
```

This runs Django's `runserver` command in the background before launching the e2e suite.

## Release

[Release Please](https://github.com/googleapis/release-please) is used to automate:

- Updating the [changelog](CHANGELOG.md).
- Calculating the new SemVer tag based on conventional commit types.
- Creating a new GitHub release.

Release Please is configured as a GitHub action ([release-please.yaml](.github/workflows/release-please.yaml)).
It keeps a release pull request open that is refreshed as changes are merged into `main`.
To cut a release, simply merge the release pull request.

### GitHub Personal Access Token

In order for Release Please to automate the above process, a GitHub Actions secret called
`RELEASE_PLEASE_TOKEN` must exist in GitHub (under `github.com/<user>/<repo>/settings/secrets/actions`).
The contents of this secret must be a Personal Access Token (PAT) with the following permissions:

```text
contents: write
pull-requests: write
```

For more information, consult the [release-please-action project](https://github.com/googleapis/release-please-action).

## Deploy `testdjereo`

The `_deploy/` directory includes a Dockerfile that uses the local development toolchain
(the `uv` project manager) to containerise the application.

### Deployment prerequisites

To deploy `testdjereo` the following must be available locally:

- [Docker](https://docs.docker.com/)

### Containerise the app

The Dockerfile runs pre-production steps, such as enabling bytecode compilation to trade a
longer installation time for faster start-up times, or running Django's `collectstatic`
command. The container's entrypoint runs [gunicorn](https://docs.gunicorn.org/en/latest/index.html)
as the WSGI web server to make the Django application available.

Build a deployment-ready image with:

```sh
docker build \
  --file _deploy/deploy.Dockerfile \
  --platform linux/amd64 \
  --build-arg CACHEBUST=$(date +%s) \
  --tag testdjereo:amd64 \
  --load .
```

N.B. The `CACHEBUST` argument ensures the layer that runs `collectstatic` is not cached
between builds.

The recommended use of the resulting container is to place it behind [nginx](https://nginx.org/en/docs/index.html)
as the reverse proxy, with `gunicorn` as the WSGI web server between the two.

---

## Developer docs

The developer README ([docs/README-dev.md](docs/README-dev.md)) covers how to work on
`testdjereo` in more detail. It covers:

- [Development prerequisites](docs/README-dev.md#development-prerequisites)
- [The djereo project template](docs/README-dev.md#the-djereo-project-template)
- [Git principles](docs/README-dev.md#git-principles)
- [Justfile recipes](docs/README-dev.md#justfile-recipes)
- [Running tests with Nox](docs/README-dev.md#running-tests-with-nox)
- [Use IPython as your shell](docs/README-dev.md#use-ipython-as-your-shell)
- [Style & pre-commit hooks](docs/README-dev.md#style--pre-commit-hooks)
- [Managing settings](docs/README-dev.md#managing-settings)
- [Use project metadata in the running application](docs/README-dev.md#use-project-metadata-in-the-running-application)
- [Security](docs/README-dev.md#security)
- [Developer tools](docs/README-dev.md#developer-tools)
- [Upgrading](docs/README-dev.md#upgrading)
  - [Upgrade checklist](docs/README-dev.md#upgrade-checklist)
- [GitHub Actions](docs/README-dev.md#github-actions)
  - [Custom GitHub Actions](docs/README-dev.md#custom-github-actions)
  - [GitHub Actions workflows](docs/README-dev.md#github-actions-workflows)
    - [`PR` (pull request)](docs/README-dev.md#pr-pull-request)
    - [`CI` (continuous integration)](docs/README-dev.md#ci-continuous-integration)
    - [Release Please](docs/README-dev.md#release-please)
    - [On tag](docs/README-dev.md#on-tag)
    - [Dependabot](docs/README-dev.md#dependabot)

---

&copy; Alberto MorÃ³n HernÃ¡ndez
